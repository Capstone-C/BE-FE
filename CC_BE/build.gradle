plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.6'
    id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.capstone'
version = '0.0.1-SNAPSHOT'
description = 'CC_BE'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

// ì ì§„ì  ì»´íŒŒì¼ í™œì„±í™” (ë¹Œë“œ ì†ë„ í–¥ìƒ)
tasks.withType(JavaCompile).configureEach {
    options.incremental = true
    options.encoding = 'UTF-8'
    
    // Spring Frameworkì˜ reflection ê¸°ë°˜ ê¸°ëŠ¥ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ì´ë¦„ ë³´ì¡´
    if (!options.compilerArgs.contains('-parameters')) {
        options.compilerArgs += '-parameters'
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // --- Spring Boot í•µì‹¬ ê¸°ëŠ¥ ---
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'
    
    // --- API ë¬¸ì„œí™” ---
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.7.0'

    // --- ë³´ì•ˆ ë° ìœ í‹¸ë¦¬í‹° ---
    implementation 'org.jsoup:jsoup:1.18.1'  // HTML Sanitizer

    // --- ê°œë°œ í¸ì˜ ë„êµ¬ ---
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'  // ê°œë°œ í™˜ê²½ Hot Reload
    developmentOnly 'org.springframework.boot:spring-boot-docker-compose'

    // --- DB ë“œë¼ì´ë²„ ---
    runtimeOnly 'com.mysql:mysql-connector-j'

    // --- JWT ì¸ì¦ ---
    implementation 'io.jsonwebtoken:jjwt-api:0.12.6'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.6'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.6'

    // --- í…ŒìŠ¤íŠ¸ (ìµœì í™”: ë¶ˆí•„ìš”í•œ ëª¨ë“ˆ ì œì™¸) ---
    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¶ˆí•„ìš”í•œ actuator endpoint ì œì™¸
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-actuator'
    }
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'com.h2database:h2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
    useJUnitPlatform()
    
    // ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (CPU ì½”ì–´ì˜ ì ˆë°˜ ì‚¬ìš©)
    maxParallelForks = Runtime.runtime.availableProcessors().intdiv(2) ?: 1
    
    // í…ŒìŠ¤íŠ¸ ë¡œê¹… ìµœì í™” (ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ìƒì„¸ ì¶œë ¥)
    testLogging {
        events "failed"  // ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë§Œ ì¶œë ¥ (CI ë¡œê·¸ ìµœì†Œí™”)
        exceptionFormat "full"
        showExceptions true
        showCauses true
        showStackTraces true
        showStandardStreams = false
    }
    
    // JVM ë©”ëª¨ë¦¬ ìµœì í™”
    jvmArgs = [
        '-Xmx1g',
        '-XX:MaxMetaspaceSize=512m',
        '-XX:+UseParallelGC',  // ë³‘ë ¬ GC ì‚¬ìš©
        '-Dfile.encoding=UTF-8'
    ]
    
    // í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ë° ì„±ëŠ¥ í–¥ìƒ
    forkEvery = 100  // 100ê°œ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆ JVM í”„ë¡œì„¸ìŠ¤ ìƒì„± (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
}

// ìƒì„±ë˜ëŠ” Boot JAR ì´ë¦„ ê³ ì • (ë°°í¬ ìë™í™”ì— ìœ ë¦¬)
bootJar {
    archiveFileName = 'cc-be.jar'
    
    // JAR íŒŒì¼ ìµœì í™”
    requiresUnpack '**/jruby-complete-*.jar'  // JRuby ì••ì¶• í•´ì œ
    launchScript()  // Unix ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
}

// ===== ì»¤ìŠ¤í…€ Gradle íƒœìŠ¤í¬ =====

/**
 * ğŸª¶ ì´ˆê³ ì† ì»´íŒŒì¼ ì²´í¬
 * ìš©ë„: ë¬¸ë²• ì˜¤ë¥˜ë§Œ ë¹ ë¥´ê²Œ í™•ì¸ (í…ŒìŠ¤íŠ¸ ìŠ¤í‚¹)
 * ì˜ˆìƒ ì‹œê°„: 10-20ì´ˆ
 */
tasks.register('lightCheck') {
    group = 'verification'
    description = 'âš¡ Lightning fast compile check (no tests, no jar)'
    
    dependsOn 'compileJava', 'compileTestJava'
    
    doLast {
        println 'âœ… ì»´íŒŒì¼ ì„±ê³µ! ì½”ë“œì— ë¬¸ë²• ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.'
    }
}

/**
 * ğŸš€ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
 * ìš©ë„: í•µì‹¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (í†µí•©í…ŒìŠ¤íŠ¸ ì œì™¸, JAR ìŠ¤í‚µ)
 * ì˜ˆìƒ ì‹œê°„: 30-60ì´ˆ
 */
tasks.register('fastTest') {
    group = 'verification'
    description = 'ğŸš€ Run fast unit tests (skip integration tests and jar building)'
    
    dependsOn 'test'
    
    // bootJarì™€ jar íƒœìŠ¤í¬ ìŠ¤í‚µ
    tasks.named('bootJar').configure {
        enabled = false
    }
    tasks.named('jar').configure {
        enabled = false
    }
    
    doFirst {
        println 'ğŸ§ª ë¹ ë¥¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
    }
    
    doLast {
        println 'âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!'
    }
}

/**
 * ğŸ” ì»´íŒŒì¼ë§Œ (í…ŒìŠ¤íŠ¸ ì½”ë“œ í¬í•¨)
 * ìš©ë„: CIì—ì„œ ì»´íŒŒì¼ ê°€ëŠ¥ ì—¬ë¶€ë§Œ í™•ì¸
 * ì˜ˆìƒ ì‹œê°„: 15-25ì´ˆ
 */
tasks.register('compileOnly') {
    group = 'build'
    description = 'ğŸ” Compile main and test code only'
    
    dependsOn 'compileJava', 'compileTestJava', 'processResources', 'processTestResources'
    
    doLast {
        println 'âœ… ì»´íŒŒì¼ ì™„ë£Œ! (í…ŒìŠ¤íŠ¸ ë¯¸ì‹¤í–‰)'
    }
}

