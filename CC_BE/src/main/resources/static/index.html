<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 관리</title>
    <style>
        /* CSS는 변경사항이 없으므로 생략합니다. 원본과 동일하게 사용하세요. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; margin-bottom: 20px; }
        .form-section { background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        textarea { resize: vertical; min-height: 100px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        button.cancel { background-color: #6c757d; }
        button.cancel:hover { background-color: #545b62; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        .posts-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .posts-table th, .posts-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .posts-table th { background-color: #f8f9fa; font-weight: bold; }
        .posts-table tr:hover { background-color: #f5f5f5; }
        .post-detail { background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-top: 30px; display: none; }
        .error, .success { padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
        .loading { text-align: center; color: #666; padding: 20px; display: none; }
        .action-buttons button { padding: 5px 10px; font-size: 14px; margin-right: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h1>게시글 관리 시스템</h1>

    <div class="error" id="errorMessage"></div>
    <div class="success" id="successMessage"></div>

    <div class="form-section">
        <h2 id="formTitle">새 게시글 작성</h2>
        <form id="postForm">
            <input type="hidden" id="postId" value="">

            <div class="form-group">
                <label for="title">제목</label>
                <input type="text" id="title" required>
            </div>

            <div class="form-group">
                <label for="authorId">작성자 ID</label>
                <input type="number" id="authorId" placeholder="실제로는 로그인 정보로 대체됩니다" required>
            </div>

            <div class="form-group">
                <label for="categoryId">카테고리</label>
                <select id="categoryId" required>
                    <option value="">카테고리를 선택하세요</option>
                </select>
            </div>

            <div class="form-group">
                <label for="content">내용</label>
                <textarea id="content" required></textarea>
            </div>

            <input type="hidden" id="status" value="PUBLISHED">
            <input type="hidden" id="isRecipe" value="false">

            <button type="submit" id="submitBtn">작성</button>
            <button type="button" class="cancel" id="cancelBtn" style="display: none;">취소</button>
        </form>
    </div>
    <div>
        <h2>게시글 목록</h2>
        <div class="loading" id="loading">로딩 중...</div>
        <table class="posts-table" id="postsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>제목</th>
                <th>작성자</th>
                <th>작성일</th>
                <th>액션</th>
            </tr>
            </thead>
            <tbody id="postsTableBody"></tbody>
        </table>
    </div>

    <div class="post-detail" id="postDetail">
        <h3 id="detailTitle"></h3>
        <p><strong>작성자:</strong> <span id="detailAuthor"></span></p>
        <p><strong>작성일:</strong> <span id="detailCreatedAt"></span></p>
        <p><strong>수정일:</strong> <span id="detailUpdatedAt"></span></p>
        <p><strong>내용:</strong></p>
        <p id="detailContent"></p>
        <button onclick="closeDetail()">닫기</button>
    </div>
</div>

<script>
    // ===== JavaScript 수정 시작 =====

    const API_BASE_URL = 'http://localhost:8080/api';

    // DOM 요소들
    const postForm = document.getElementById('postForm');
    const postIdInput = document.getElementById('postId');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const authorIdInput = document.getElementById('authorId');
    const categoryIdInput = document.getElementById('categoryId');
    const statusInput = document.getElementById('status');
    const isRecipeInput = document.getElementById('isRecipe');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const postsTableBody = document.getElementById('postsTableBody');
    const postDetail = document.getElementById('postDetail');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const loading = document.getElementById('loading');

    // 메시지 표시 함수
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => errorMessage.style.display = 'none', 3000);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        setTimeout(() => successMessage.style.display = 'none', 3000);
    }

    // (신규) 카테고리 목록을 불러와 드롭다운을 채우는 함수
    async function fetchCategories() {
        try {
            // 이 API는 백엔드에 직접 구현해야 합니다: GET /api/categories
            const response = await fetch(`${API_BASE_URL}/categories`);
            if (!response.ok) throw new Error('카테고리를 불러올 수 없습니다.');
            const categories = await response.json();

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categoryIdInput.appendChild(option);
            });
        } catch (error) {
            showError(error.message);
            console.error('Error fetching categories:', error);
        }
    }

    // 모든 게시글 조회
    async function fetchAllPosts() {
        try {
            loading.style.display = 'block';
            const response = await fetch(`${API_BASE_URL}/posts`);
            if (!response.ok) throw new Error('게시글을 불러올 수 없습니다.');
            const posts = await response.json();

            postsTableBody.innerHTML = '';
            // 백엔드 응답 DTO에 authorName이 포함되어 있다고 가정합니다.
            posts.forEach(post => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${post.id}</td>
                    <td>${post.title}</td>
                    <td>${post.authorName || 'N/A'}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td class="action-buttons">
                        <button onclick="viewPost(${post.id})">보기</button>
                        <button onclick="editPost(${post.id})">수정</button>
                        <button class="delete" onclick="deletePost(${post.id})">삭제</button>
                    </td>
                `;
                postsTableBody.appendChild(row);
            });
        } catch (error) {
            showError(error.message);
            console.error('Error fetching posts:', error);
        } finally {
            loading.style.display = 'none';
        }
    }

    // 특정 게시글 조회
    async function viewPost(id) {
        try {
            const response = await fetch(`${API_BASE_URL}/posts/${id}`);
            if (!response.ok) throw new Error('게시글을 불러올 수 없습니다.');
            const post = await response.json();

            document.getElementById('detailTitle').textContent = post.title;
            document.getElementById('detailAuthor').textContent = post.authorName || 'N/A';
            document.getElementById('detailCreatedAt').textContent = new Date(post.createdAt).toLocaleString();
            document.getElementById('detailUpdatedAt').textContent = new Date(post.updatedAt).toLocaleString();
            document.getElementById('detailContent').textContent = post.content;

            postDetail.style.display = 'block';
        } catch (error) {
            showError(error.message);
            console.error('Error viewing post:', error);
        }
    }

    // 게시글 수정 모드
    async function editPost(id) {
        try {
            const response = await fetch(`${API_BASE_URL}/posts/${id}`);
            if (!response.ok) throw new Error('게시글 정보를 가져올 수 없습니다.');
            const post = await response.json();

            // 백엔드 응답 DTO에 authorId, categoryId 등이 포함되어 있다고 가정합니다.
            postIdInput.value = post.id;
            titleInput.value = post.title;
            authorIdInput.value = post.authorId || '';
            categoryIdInput.value = post.categoryId || '';
            statusInput.value = post.status;
            isRecipeInput.value = post.isRecipe;
            contentInput.value = post.content;

            authorIdInput.readOnly = true; // 작성자 ID는 수정 불가

            formTitle.textContent = '게시글 수정';
            submitBtn.textContent = '수정';
            cancelBtn.style.display = 'inline-block';
            window.scrollTo(0, 0);
        } catch (error) {
            showError(error.message);
            console.error('Error editing post:', error);
        }
    }

    // 게시글 삭제
    async function deletePost(id) {
        if (!confirm('정말로 이 게시글을 삭제하시겠습니까?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/posts/${id}`, { method: 'DELETE' });
            if (response.status === 204) {
                showSuccess('게시글이 삭제되었습니다.');
                fetchAllPosts();
            } else {
                showError('게시글 삭제에 실패했습니다.');
            }
        } catch (error) {
            showError('게시글 삭제 중 오류가 발생했습니다.');
            console.error('Error deleting post:', error);
        }
    }

    // 상세보기 닫기
    function closeDetail() {
        postDetail.style.display = 'none';
    }

    // 폼 리셋 함수
    function resetForm() {
        postForm.reset();
        postIdInput.value = '';
        authorIdInput.readOnly = false;
        formTitle.textContent = '새 게시글 작성';
        submitBtn.textContent = '작성';
        cancelBtn.style.display = 'none';
    }

    // 폼 제출 처리
    postForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const postId = postIdInput.value;
        let postData;
        let url = `${API_BASE_URL}/posts`;
        let method = 'POST';

        if (postId) { // 수정
            url = `${API_BASE_URL}/posts/${postId}`;
            method = 'PUT';
            postData = { // UpdateRequest DTO
                title: titleInput.value,
                content: contentInput.value,
                categoryId: parseInt(categoryIdInput.value),
                status: statusInput.value,
                isRecipe: isRecipeInput.value.toLowerCase() === 'true'
            };
        } else { // 생성
            postData = { // CreateRequest DTO
                title: titleInput.value,
                content: contentInput.value,
                authorId: parseInt(authorIdInput.value),
                categoryId: parseInt(categoryIdInput.value),
                status: statusInput.value,
                isRecipe: isRecipeInput.value.toLowerCase() === 'true'
            };
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(postData)
            });

            if (response.ok) {
                showSuccess(postId ? '게시글이 수정되었습니다.' : '게시글이 작성되었습니다.');
                resetForm();
                fetchAllPosts();
            } else {
                const errorData = await response.json();
                showError(`작업 실패: ${errorData.message || '서버 오류'}`);
            }
        } catch (error) {
            showError('네트워크 오류가 발생했습니다.');
            console.error('Error submitting form:', error);
        }
    });

    // 취소 버튼
    cancelBtn.addEventListener('click', resetForm);

    // 페이지 로드 시 초기 데이터 로드
    function initializePage() {
        fetchAllPosts();
        fetchCategories();
    }

    initializePage();

    // ===== JavaScript 수정 끝 =====
</script>
</body>
</html>