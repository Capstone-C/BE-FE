name: Backend CI

# 이 workflow가 실행되는 조건
on:
  # PR이 생성되거나 업데이트될 때
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  # main이나 develop 브랜치에 push될 때
  push:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'

# 동시에 여러 workflow가 실행되지 않도록 설정
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # 1. 코드 체크아웃 (최소한의 히스토리만 가져오기)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 최신 커밋만 가져오기
      
      # 2. JDK 17 설정 (Gradle 캐싱 활성화)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      # 3. Gradle 의존성 캐싱 (별도 추가로 빌드 속도 향상)
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      # 4. Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # 5. Gradle 빌드 (테스트 포함) - 병렬 실행 및 최적화
      - name: Build with Gradle
        working-directory: ./CC_BE
        run: ./gradlew clean build --no-daemon --parallel --build-cache --console=plain
        env:
          SPRING_PROFILES_ACTIVE: test
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC"
      
      # 6. 테스트 결과 업로드 (실패 시에만 - 성공 시 불필요)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()  # 실패 시에만 업로드
        with:
          name: test-results-${{ github.run_number }}  # 실행 번호 추가로 충돌 방지
          path: CC_BE/build/reports/tests/test/
          retention-days: 3  # 7일 → 3일로 단축

  # 코드 품질 검사 (선택사항) - 테스트와 병렬 실행
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # Checkstyle이나 SpotBugs 같은 도구 실행 (설정되어 있다면)
      - name: Run code quality checks
        working-directory: ./CC_BE
        run: ./gradlew check -x test --no-daemon --parallel --build-cache --console=plain
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m"