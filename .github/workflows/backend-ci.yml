name: ğŸ”¥ Backend Full CI

# ì™„ì „í•œ CI: main ë¸Œëœì¹˜ ë³‘í•© ì „, ë¦´ë¦¬ì¦ˆ ì „ìš© (ëª©í‘œ: 2-3ë¶„)
on:
  # main ë¸Œëœì¹˜ë¡œì˜ PRë§Œ (ì¤‘ìš”í•œ ë³‘í•©)
  pull_request:
    branches: [ main ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ (ë³‘í•© ì™„ë£Œ í›„)
  push:
    branches: [ main ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# ë™ì‹œì— ì—¬ëŸ¬ workflowê°€ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìµœì†Œí•œì˜ íˆìŠ¤í† ë¦¬ë§Œ ê°€ì ¸ì˜¤ê¸°)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ìµœì‹  ì»¤ë°‹ë§Œ ê°€ì ¸ì˜¤ê¸°
      
      # 2. JDK 17 ì„¤ì • (Gradle ìºì‹± í™œì„±í™”)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      # 3. Gradle ì˜ì¡´ì„± ìºì‹± (ë³„ë„ ì¶”ê°€ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # 5. Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨) - ë³‘ë ¬ ì‹¤í–‰ ë° ìµœì í™”
      - name: Build with Gradle
        working-directory: ./CC_BE
        run: ./gradlew clean build --no-daemon --parallel --build-cache --console=plain
        env:
          SPRING_PROFILES_ACTIVE: test
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC"
      
      # 6. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë§Œ - ì„±ê³µ ì‹œ ë¶ˆí•„ìš”)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()  # ì‹¤íŒ¨ ì‹œì—ë§Œ ì—…ë¡œë“œ
        with:
          name: test-results-${{ github.run_number }}  # ì‹¤í–‰ ë²ˆí˜¸ ì¶”ê°€ë¡œ ì¶©ëŒ ë°©ì§€
          path: CC_BE/build/reports/tests/test/
          retention-days: 3  # 7ì¼ â†’ 3ì¼ë¡œ ë‹¨ì¶•

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ì„ íƒì‚¬í•­) - í…ŒìŠ¤íŠ¸ì™€ ë³‘ë ¬ ì‹¤í–‰
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # Checkstyleì´ë‚˜ SpotBugs ê°™ì€ ë„êµ¬ ì‹¤í–‰ (ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´)
      - name: Run code quality checks
        working-directory: ./CC_BE
        run: ./gradlew check -x test --no-daemon --parallel --build-cache --console=plain
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m"