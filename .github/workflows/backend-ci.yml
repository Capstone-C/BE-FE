name: Backend CI

# 이 workflow가 실행되는 조건
on:
  # PR이 생성되거나 업데이트될 때
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  # main이나 develop 브랜치에 push될 때
  push:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'

# 동시에 여러 workflow가 실행되지 않도록 설정
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    # MySQL Service Container 설정
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: ccdb_test
          MYSQL_USER: ccuser
          MYSQL_PASSWORD: testpass
          MYSQL_ROOT_PASSWORD: rootpass
          TZ: Asia/Seoul
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -p$MYSQL_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      # 3. Tesseract OCR 설치 (OCR 테스트용)
      - name: Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-kor
          tesseract --version
          echo "TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata" >> $GITHUB_ENV
      
      # 4. Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # 5. 테스트용 application.yml 생성 (필요한 경우)
      - name: Create test application.yml
        working-directory: ./CC_BE
        run: |
          mkdir -p src/test/resources
          cat > src/test/resources/application-test.yml << EOF
          spring:
            datasource:
              url: jdbc:mysql://localhost:3306/ccdb_test
              username: ccuser
              password: testpass
              driver-class-name: com.mysql.cj.jdbc.Driver
            jpa:
              hibernate:
                ddl-auto: create-drop
              properties:
                hibernate:
                  format_sql: true
          
          # OCR Tesseract 설정
          ocr:
            tesseract:
              datapath: /usr/share/tesseract-ocr/5/tessdata
              language: kor+eng
          EOF
      
      # 6. Gradle 빌드 (테스트 포함)
      - name: Build with Gradle
        working-directory: ./CC_BE
        run: ./gradlew clean build --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
      
      # 7. 테스트 결과 업로드 (실패 시에도 실행)
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: CC_BE/build/reports/tests/test/
          retention-days: 7
      
      # 8. 테스트 커버리지 리포트 (JaCoCo 사용 시)
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-reports
          path: CC_BE/build/reports/jacoco/
          retention-days: 7

  # 코드 품질 검사 (선택사항)
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew
      
      # Checkstyle이나 SpotBugs 같은 도구 실행 (설정되어 있다면)
      - name: Run code quality checks
        working-directory: ./CC_BE
        run: ./gradlew check -x test --no-daemon
