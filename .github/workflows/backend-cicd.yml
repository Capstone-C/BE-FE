name: Backend CI/CD

# [트리거]
on:
  # PR이 열릴 때 (테스트만 실행됨)
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  # main/develop 브랜치에 푸시(merge)될 때
  push:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# [환경 변수]
env:
  AWS_REGION: "ap-northeast-2"
  ECR_REPOSITORY: "capston-cc"
  ASG_NAME: "prod-was-asg" 
  ECR_REGISTRY: "559198857556.dkr.ecr.ap-northeast-2.amazonaws.com"

# [권한]
permissions:
  id-token: write 
  contents: read

# [작업 목록]
jobs:
  # -----------------------------------------------
  # [ 1. 테스트 작업 ] (사용자님이 만드신 코드)
  #  - 모든 PR과 모든 Push에서 실행됩니다.
  # -----------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: ccdb_test
          MYSQL_USER: ccuser
          MYSQL_PASSWORD: devpass
          MYSQL_ROOT_PASSWORD: rootpass
          TZ: Asia/Seoul
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -p$MYSQL_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-kor
          tesseract --version
          echo "TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata" >> $GITHUB_ENV
      
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE # (경로 수정)
        run: chmod +x gradlew
      
      - name: Create test application.yml
        working-directory: ./CC_BE # (경로 수정)
        run: |
          mkdir -p src/test/resources
          cat > src/test/resources/application-test.yml << EOF
          spring:
            datasource:
              url: jdbc:mysql://localhost:3306/ccdb_test
              username: ccuser
              password: devpass
              driver-class-name: com.mysql.cj.jdbc.Driver
            jpa:
              hibernate:
                ddl-auto: create-drop
              properties:
                hibernate:
                  format_sql: true
          
          ocr:
            tesseract:
              datapath: /usr/share/tesseract-ocr/5/tessdata
              language: kor+eng
          EOF
      
      - name: Build with Gradle
        working-directory: ./CC_BE # (경로 수정)
        run: ./gradlew clean build --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

  # -----------------------------------------------
  # [ 2. 빌드 및 ECR 푸시 작업 ]
  #  - "main" 브랜치에 Push될 때 + "test" 작업이 성공했을 때만 실행
  # -----------------------------------------------
  build-and-push-ecr:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    needs: test # ⬅️ [중요] 1번(test) 작업이 성공해야만 실행됩니다.
    
    # [ ⭐️ 핵심 조건 ⭐️ ]
    # 'main' 브랜치에 'push' (merge) 이벤트가 발생했을 때만 실행합니다.
    # (PR이거나 develop 브랜치 푸시일 때는 실행되지 않습니다.)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::559198857556:role/GitHubActions-CICD-Role # ⬅️ 11시 07분에 설명드린 OIDC 역할
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          IMAGE_TAG: "latest" 
        run: |
          # ECR 전체 주소로 이미지를 빌드합니다 (docker tag 불필요)
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ./CC_BE
          
          # ECR로 푸시
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

  # -----------------------------------------------
  # [ 3. EC2 롤링 배포 작업 ] 
  #  - "build-and-push-ecr" 작업이 성공했을 때만 실행
  # -----------------------------------------------
  deploy-to-ec2-asg:
    name: Start Rolling Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push-ecr # ⬅️ [중요] 2번(build) 작업이 성공해야만 실행됩니다.
    
    # (조건은 2번 작업과 동일하게 main 브랜치 push일 때만 실행됩니다.)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::559198857556:role/GitHubActions-CICD-Role # ⬅️ 11시 07분에 설명드린 OIDC 역할
          aws-region: ${{ env.AWS_REGION }}

      - name: Start ASG Instance Refresh (Rolling Update)
        run: |
          echo "Starting instance refresh (rolling update) for ASG: ${{ env.ASG_NAME }}"
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300
            }'
          echo "Instance refresh started. ASG will now terminate old instances and launch new ones with the 'latest' ECR image."