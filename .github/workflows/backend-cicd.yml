name: Backend CI/CD

# [트리거]
on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'
  
  push:
    branches: [ main, develop ]
    paths:
      - 'CC_BE/**'
      - '.github/workflows/backend-ci.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: "ap-northeast-2"
  ECR_REPOSITORY: "capston-cc"
  ASG_NAME: "prod-was-asg"
  ECR_REGISTRY: "559198857556.dkr.ecr.ap-northeast-2.amazonaws.com"

permissions:
  id-token: write 
  contents: read

jobs:
  # -----------------------------------------------
  # [ 1. 테스트 작업 ]
  # -----------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: ccdb_test
          MYSQL_USER: ccuser
          MYSQL_PASSWORD: devpass
          MYSQL_ROOT_PASSWORD: rootpass
          TZ: Asia/Seoul
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -p$MYSQL_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-kor
          tesseract --version
          echo "TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata" >> $GITHUB_ENV
      
      - name: Grant execute permission for gradlew
        working-directory: ./CC_BE
        run: chmod +x gradlew

      - name: Disable foreign key checks in MySQL
        run: |
          mysql -h localhost -u root -prootpass -e "SET GLOBAL foreign_key_checks = 0;"
      
      - name: Create test application.yml
        working-directory: ./CC_BE
        run: |
          mkdir -p src/test/resources
          cat > src/test/resources/application-test.yml << EOF
          spring:
            datasource:
              url: jdbc:mysql://localhost:3306/ccdb_test
              username: ccuser
              password: devpass
              driver-class-name: com.mysql.cj.jdbc.Driver
            jpa:
              hibernate:
                ddl-auto: create-drop
              properties:
                hibernate:
                  format_sql: true
                  temp:
                    use_jdbc_metadata_defaults: false
          ocr:
            tesseract:
              datapath: /usr/share/tesseract-ocr/5/tessdata
              language: kor+eng
          EOF
      
      - name: Build with Gradle
        working-directory: ./CC_BE
        run: ./gradlew clean build --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

  # -----------------------------------------------
  # [ 2. 빌드 및 ECR 푸시 작업 ]
  # -----------------------------------------------
  build-and-push-ecr:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::559198857556:role/GitHubActions-CICD-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          IMAGE_TAG: "latest"
        run: |
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ./CC_BE
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

  # -----------------------------------------------
  # [ 3. EC2 롤링 배포 작업 ]
  # -----------------------------------------------
  deploy-to-ec2-asg:
    name: Start Rolling Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push-ecr
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::559198857556:role/GitHubActions-CICD-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Start ASG Instance Refresh (Rolling Update)
        run: |
          echo "Starting instance refresh (rolling update) for ASG: ${{ env.ASG_NAME }}"
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300
            }'
          echo "Instance refresh started. ASG will now terminate old instances and launch new ones with the 'latest' ECR image."
